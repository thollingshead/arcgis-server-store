/* arcgis-server-store v1.1.0 | 2016-10-31 | github.com/thollingshead/arcgis-server-store */
define(["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/promise/all","dojo/store/util/QueryResults","dojo/when","esri/request","esri/tasks/query"],function(a,b,c,d,e,f,g,h,i){var j=function(a,b,d){return function(){var e=arguments;return d._transaction&&(e[1]=c.mixin({_transaction:d._transaction},e[1]),e.length=Math.max(e.length,2)),a.then(function(){return b.apply(d,e)})}},k=function(a,b,c){return function(){var e=arguments,g=new d;return g.total=new d,a.then(function(){try{var a=b.apply(c,e);a.then(g.resolve,g.reject),a.total.then(g.total.resolve,g.total.reject)}catch(a){g.reject(a),g.total.reject(a)}}),f(g)}},l=function(a,b,c){return function(){return b.apply(c,arguments),{commit:p(function(){var b=this;return a.then(function(){return o.apply(b)})},c,c._transaction),abort:p(function(){var b=this;return a.then(function(){return n.apply(b)})},c,c._transaction)}}},m=function(a,b){return a.index-b.index},n=function(b){var e=new d;if(this._aborted)e.cancel("Transaction aborted.");else if(this._committed)e.reject("Transaction committed.");else{this._aborted=!0;var f=[].concat(this._promises,this.puts,this.adds,this.removes);a.forEach(f,function(a){a&&(a=a.deferred||a,c.isFunction(a.cancel)&&a.cancel(b||"Transaction aborted."))}),e.resolve()}return e.promise},o=function(){var b=new d;if(this._aborted)b.reject("Transaction aborted.");else{if(!this._committed)return this._committed=!0,e(this._promises||[]).then(c.hitch(this,function(){var b=a.map(this.puts.sort(m)||[],function(a){return a.feature}),d=a.map(this.adds.sort(m)||[],function(a){return a.feature}),e=[];return a.forEach(this.removes.sort(m)||[],function(a){e=e.concat(a.ids)}),h({url:this._store.url+"/applyEdits",content:{f:"json",updates:JSON.stringify(b),adds:JSON.stringify(d),deletes:e.join(",")},handleAs:"json",callbackParamName:"callback"},{usePost:!0}).then(c.hitch(this,function(b){var d={};return d.put=a.map(this.puts,c.hitch(this,function(a,c){var d,e=b.updateResults[c];return e.success?(d=this._store.idProperty===this._store._serviceInfo.objectIdField?e.objectId:a.id,a.deferred.resolve(d)):a.deferred.reject(),d})),d.add=a.map(this.adds,c.hitch(this,function(a,c){var d,e=b.addResults[c];return e.success?(d=this._store.idProperty===this._store._serviceInfo.objectIdField?e.objectId:"undefined"!=typeof a.id?a.id:null,a.deferred.resolve(d)):a.deferred.reject(),d})),d.remove=a.map(this.removes,function(c){return c.ids=a.filter(c.ids,function(c){var d=a.some(b.deleteResults,function(a){return a.objectId===c&&a.success});return!d}),c.ids.length?void c.deferred.reject():(c.deferred.resolve(!0),c.id)}),d}),c.hitch(this,function(a){this._committed=!1,n.apply(this,arguments)}))}),c.hitch(this,function(){this._committed=!1,n.apply(this,arguments)}));b.cancel("Transaction committed.")}return b.promise},p=function(a,b,c){return function(){return b._transaction===c&&delete b._transaction,a.apply(c)}};return b(null,{idProperty:"OBJECTID",flatten:!0,returnGeometry:!0,constructor:function(a){if(this.outFields=["*"],b.safeMixin(this,a),this.capabilities={Data:!1,Query:!1,Create:!1,Delete:!1,Update:!1,Editing:!1},!this.url)throw new Error("Missing required property: 'url'.");var d=h({url:this.url,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(c.hitch(this,"_initStore")),e=this.get,f=this.add,g=this.put,i=this.remove,m=this.query,n=this.transaction;d.then(c.hitch(this,function(){this.get=e,this.add=f,this.put=g,this.remove=i,this.query=m,this.transaction=n})),this.get=j(d,this.get,this),this.add=j(d,this.add,this),this.put=j(d,this.put,this),this.remove=j(d,this.remove,this),this.query=k(d,this.query,this),this.transaction=l(d,this.transaction,this)},get:function(a){if(this._serviceInfo.templates?this.capabilities.Query:this.capabilities.Data){var b=new i;return b.outFields=this.outFields,b.returnGeometry=this.returnGeometry,"string"==typeof a?b.where=this.idProperty+" = '"+a+"'":b.where=this.idProperty+" = "+a,h({url:this.url+"/query",content:c.mixin(b.toJson(),{f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(c.hitch(this,function(a){return a.features&&a.features.length?this.flatten?this._flatten(a.features[0]):a.features[0]:void 0}))}throw new Error("Get not supported.")},getIdentity:function(a){return this.flatten?a[this.idProperty]:c.getObject("attributes."+this.idProperty,!1,a)},put:function(a,b){b=b||{};var e="id"in b?b.id:this.getIdentity(a);if("undefined"!=typeof e&&b.overwrite!==!1){var f=new d,i=g(b.overwrite||this.get(e)),j=b._transaction||this._transaction;if(j){var k=j._index++;j._promises.push(i)}return i.then(c.hitch(this,function(d){d?this.capabilities.Update?(a=this._unflatten(c.clone(a)),c.setObject("attributes."+this.idProperty,e,a),j?j.puts.push({index:k,id:e,deferred:f,feature:a}):h({url:this.url+"/updateFeatures",content:{f:"json",features:JSON.stringify([a])},handleAs:"json",callbackParamName:"callback"},{usePost:!0}).then(c.hitch(this,function(a){a.updateResults&&a.updateResults.length&&(this.idProperty===this._serviceInfo.objectIdField?f.resolve(a.updateResults[0].success?a.updateResults[0].objectId:void 0):f.resolve(a.updateResults[0].success?e:void 0))}),f.reject)):f.reject(new Error("Update not supported.")):(j&&!b._transaction&&(b=c.clone(b),b._transaction=j),g(this.add(a,b)).then(f.resolve,f.reject))})),f.promise}if(b.overwrite)throw new Error("Cannot update object with no id.");return this.add(a,b)},add:function(a,b){if(b=b||{},this.capabilities.Create){var e=new d,f="id"in b?b.id:this.getIdentity(a);"undefined"!=typeof f&&this.idProperty===this._serviceInfo.objectIdField&&(console.warn("Cannot set id on new object."),f=void 0);var g=this._unflatten(c.clone(a));c.setObject("attributes."+this.idProperty,f,g);var i=b._transaction||this._transaction;return i?i.adds.push({index:i._index++,id:f,deferred:e,feature:g}):h({url:this.url+"/addFeatures",content:{f:"json",features:JSON.stringify([g])},handleAs:"json",callbackParamName:"callback"},{usePost:!0}).then(c.hitch(this,function(b){if(b.addResults&&b.addResults.length)if(this.idProperty===this._serviceInfo.objectIdField){var d=b.addResults[0].success?b.addResults[0].objectId:void 0;c.setObject((this.flatten?"":"attributes.")+this.idProperty,d,a),e.resolve(d)}else e.resolve(b.addResults[0].success?f:void 0)}),e.reject),e.promise}throw new Error("Add not supported.")},remove:function(a,b){if(b=b||{},this.capabilities.Delete){var e=new d,f="";"string"==typeof a?f=this.idProperty+" = '"+a+"'":"undefined"!=typeof a&&(f=this.idProperty+" = "+a);var g=b._transaction||this._transaction;if(g){var i=g._index++;if(this.idProperty===this._serviceInfo.objectIdField)g.removes.push({index:i,id:a,deferred:e,ids:[a]});else{var j=h({url:this.url+"/query",content:{f:"json",where:f,returnIdsOnly:!0},handleAs:"json",callbackParamaName:"callback"}).then(c.hitch(this,function(b){b.objectIds&&g.removes.push({index:i,id:a,deferred:e,ids:b.objectIds})}),e.reject);g._promises.push(j)}}else h({url:this.url+"/deleteFeatures",content:{f:"json",where:f},handleAs:"json",callbackParamName:"callback"},{usePost:!0}).then(function(a){e.resolve(!(!a||!a.success))},e.reject);return e.promise}throw new Error("Remove not supported.")},query:function(b,e){if(e=e||{},b=b instanceof i?b:this._objectToQuery(b),this._serviceInfo.templates?this.capabilities.Query:this.capabilities.Data){var g=new d;b.where=b.where||"1=1",b.outFields=b.outFields||this.outFields,b.returnGeometry=this.returnGeometry,e.sort&&(b.orderByFields=a.map(e.sort,function(a){return a.descending?a.attribute+" DESC":a.attribute}));var j=!1;return e.start=isFinite(e.start)?e.start:0,e.count=isFinite(e.count)?e.count:0,(e.start>0||e.count>0)&&(e.count>this._serviceInfo.maxRecordCount&&console.warn("Cannot return more than "+this._serviceInfo.maxRecordCount+" items."),c.getObject("_serviceInfo.advancedQueryCapabilities.supportsPagination",!1,this)?(b.start=e.start,b.num=e.count,(!b.orderByFields||b.orderByFields.length<1)&&(b.orderByFields=[this.idProperty])):j=!0),j&&e.start+e.count>this._serviceInfo.maxRecordCount?g.total=h({url:this.url+"/query",content:c.mixin(b.toJson(),{orderByFields:"",returnIdsOnly:!0,f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(c.hitch(this,function(d){return d.objectIds?(b.where="",b.objectIds=d.objectIds.slice(e.start,e.start+e.count),h({url:this.url+"/query",content:c.mixin(b.toJson(),{f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(c.hitch(this,function(b){this.flatten&&(b.features=a.map(b.features,c.hitch(this,function(a){return this._flatten(a)}))),g.resolve(b.features)}),g.reject),d.objectIds.length):void g.reject(d)}),g.reject):(h({url:this.url+"/query",content:c.mixin(b.toJson(),{f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(c.hitch(this,function(b){j&&(b.features=b.features.slice(e.start,e.start+e.count)),this.flatten&&(b.features=a.map(b.features,c.hitch(this,function(a){return this._flatten(a)}))),g.resolve(b.features)}),g.reject),g.total=h({url:this.url+"/query",content:c.mixin(b.toJson(),{orderByFields:void 0,resultOffset:void 0,resultRecordCount:void 0,returnCountOnly:!0,f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(function(a){return a.count})),f(g)}throw new Error("Query not supported.")},transaction:function(){var a={_index:0,_store:this,_promises:[],puts:[],adds:[],removes:[]};return this._transaction=a,{commit:p(o,this,a),abort:p(n,this,a)}},_flatten:function(a){return a.attributes&&(a=c.mixin(a,a.attributes),delete a.attributes),a},_unflatten:function(b){var d,e;e=this.outFields.length&&"*"!==this.outFields[0]?this.outFields:a.map(this._serviceInfo.fields,function(a){return a.name});for(d in b)b.hasOwnProperty(d)&&a.indexOf(e,d)!==-1&&(c.setObject("attributes."+d,b[d],b),delete b[d]);return b},_initStore:function(b){var d=!1;if(this.idProperty&&(d=a.some(b.fields,c.hitch(this,function(a){return a.name===this.idProperty}))),d||(b.objectIdField?this.idProperty=b.objectIdField:a.some(b.fields,c.hitch(this,function(a){"esriFieldTypeOID"===a.type&&(this.idProperty=a.name)}))),this.outFields.length&&"*"!==this.outFields[0]?(this.outFields=a.filter(this.outFields,function(c){return a.some(b.fields,function(a){return a.name===c})}),a.indexOf(this.outFields,this.idProperty)===-1&&this.outFields.push(this.idProperty)):this.outFields=["*"],b.capabilities){var e=b.capabilities.split(",");a.forEach(e,c.hitch(this,function(a){this.capabilities[a]=!0}))}this._serviceInfo=b,this._loaded=!0},_objectToQuery:function(b){var c=!1,d=[];for(var e in b)if(b.hasOwnProperty(e))if(f=b[e],f instanceof RegExp&&"function"==typeof f.toString){var f=f.toString();f=f.replace(/(\\\\)|(%|_)|(\\\*|\\\?)|(\*)|(\?)/g,function(a,b,d,e,f,g){return c=c||!!d,d?"\\"+a:e?e[1]:f?"%":g?"_":a}),d.push(e+" LIKE '"+f+"'")}else"string"==typeof f?(f=f.replace(/(\\|%|_)/g,function(a){return"\\"+a}),d.push(e+" = '"+f+"'")):d.push(e+" = "+f);c||(d=a.map(d,function(a){return a.replace(/(\\.)/g,function(a){return a[1]})}));var g=new i;return g.where=d.join(" AND ")+(c?" ESCAPE '\\'":""),g}})});